name: üßπ Cleanup Server

on:
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup disk space
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: ‚öôÔ∏è Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << EOF
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 10
            TCPKeepAlive yes
            StrictHostKeyChecking no
          EOF
      
      - name: üßπ Deep cleanup server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          echo "üßπ Starting deep server cleanup..."
          
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
          echo "üìä Disk usage BEFORE cleanup:"
          df -h /
          
          echo ""
          echo "üõë Stopping old containers..."
          cd /root/photobooks 2>/dev/null || cd /var/www/photobooksgallery 2>/dev/null || true
          docker compose down 2>/dev/null || true
          
          echo ""
          echo "üóëÔ∏è  Removing ALL unused Docker images..."
          docker image prune -af
          
          echo ""
          echo "üóëÔ∏è  Removing unused volumes..."
          docker volume prune -f
          
          echo ""
          echo "üóëÔ∏è  Removing build cache..."
          docker builder prune -af
          
          echo ""
          echo "üóëÔ∏è  Removing unused networks..."
          docker network prune -f
          
          echo ""
          echo "üóëÔ∏è  Docker system prune (full)..."
          docker system prune -af --volumes
          
          echo ""
          echo "üóëÔ∏è  Cleaning old logs..."
          find /var/log -type f -name "*.log" -mtime +3 -delete 2>/dev/null || true
          find /var/log -type f -name "*.gz" -delete 2>/dev/null || true
          truncate -s 0 /var/log/syslog 2>/dev/null || true
          journalctl --vacuum-time=3d 2>/dev/null || true
          
          echo ""
          echo "üóëÔ∏è  Cleaning tmp..."
          rm -rf /tmp/* 2>/dev/null || true
          rm -rf /var/tmp/* 2>/dev/null || true
          
          echo ""
          echo "üóëÔ∏è  Cleaning apt cache..."
          apt-get clean 2>/dev/null || true
          apt-get autoremove -y 2>/dev/null || true
          
          echo ""
          echo "üìä Disk usage AFTER cleanup:"
          df -h /
          
          echo ""
          echo "üìä Docker disk usage:"
          docker system df
          
          echo ""
          echo "‚úÖ Cleanup complete!"
          ENDSSH
      
      - name: üì± Notify Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            TEXT="üßπ –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
          else
            TEXT="‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–µ—Ä–≤–µ—Ä–∞"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${TEXT}\"}" || true
