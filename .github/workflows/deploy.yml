name: üöÄ Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to photobooksgallery.am
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: ‚öôÔ∏è Configure SSH for long connections
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << EOF
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 120
            TCPKeepAlive yes
            StrictHostKeyChecking no
          EOF
      
      - name: üì¶ Create deployment archive
        run: |
          echo "Creating archive with git archive..."
          git archive --format=tar.gz -o deploy.tar.gz HEAD
          echo "Archive created successfully!"
          ls -lh deploy.tar.gz
          echo "Archive size: $(du -h deploy.tar.gz | cut -f1)"
      
      - name: üßπ Cleanup server (free disk space)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –µ–≥–æ
          scp cleanup-server.sh ${SERVER_USER}@${SERVER_HOST}:/tmp/
          ssh ${SERVER_USER}@${SERVER_HOST} "chmod +x /tmp/cleanup-server.sh && bash /tmp/cleanup-server.sh; rm -f /tmp/cleanup-server.sh || true"
      
      - name: üìÅ Ensure server directory exists
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH} && chmod 755 ${SERVER_PATH}"
      
      - name: üöö Upload to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          scp deploy.tar.gz ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
      
      - name: üîß Deploy on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          AR_POSTGRES_PASSWORD: ${{ secrets.AR_POSTGRES_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π .env —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ
          cat > .env.deploy << EOF
          POSTGRES_DB=photobooks_db
          POSTGRES_USER=photobooks
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          DATABASE_URL=postgresql://photobooks:${POSTGRES_PASSWORD}@db:5432/photobooks_db
          AR_POSTGRES_PASSWORD=${AR_POSTGRES_PASSWORD}
          AR_DATABASE_URL=postgresql://photobooks:${AR_POSTGRES_PASSWORD}@ar-db:5432/ar_db
          DOMAIN=photobooksgallery.am
          FRONTEND_URL=https://photobooksgallery.am
          API_URL=https://photobooksgallery.am
          ALLOWED_ORIGINS=https://photobooksgallery.am
          TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
          
          # –ö–æ–ø–∏—Ä—É–µ–º .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          scp .env.deploy ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/.env
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π (SSH keepalive –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ ~/.ssh/config)
          ssh ${SERVER_USER}@${SERVER_HOST} \
            "cd ${SERVER_PATH} && \
            echo '--- Archive extract ---' && \
            tar xzf deploy.tar.gz && rm deploy.tar.gz && \
            echo '--- Pre-clean containers ---' && \
            docker compose down -v --remove-orphans || true && \
            docker rm -f photobooks-ar-db photobooks_db photobooks-backend photobooks-ar-service photobooks-frontend photobooks-migrator 2>/dev/null || true && \
            echo '--- Build images (fresh) ---' && \
            docker compose build --no-cache && \
            echo '--- Start stack ---' && \
            docker compose up -d && \
            echo '--- Wait for services ---' && \
            sleep 12 && \
            docker compose ps && \
            echo '--- Prune dangling images ---' && \
            docker image prune -af || true && \
            echo '‚úÖ Deployment completed successfully!'"
      
      - name: üì± Notify Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            TEXT="‚úÖ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ï–ù!

–ö–æ–º–º–∏—Ç: ${{ github.sha }}
–í–µ—Ç–∫–∞: ${{ github.ref_name }}
–°–∞–π—Ç: https://photobooksgallery.am"
          else
            TEXT="‚ùå –î–ï–ü–õ–û–ô –ü–†–û–í–ê–õ–ò–õ–°–Ø!

–ö–æ–º–º–∏—Ç: ${{ github.sha }}
–í–µ—Ç–∫–∞: ${{ github.ref_name }}
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ GitHub Actions"
          fi
          
          echo "üì± –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (status=$STATUS)..."
          
          # JSON POST —Å jq –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": $(echo "$TEXT" | jq -Rs .)}")
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ Telegram API:"
            echo "$RESPONSE"
            exit 1
          fi
