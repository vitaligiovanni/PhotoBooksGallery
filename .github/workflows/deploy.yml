name: üöÄ Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to photobooksgallery.am
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: üì¶ Create deployment archive
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º git archive –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ –∏–∑ git
          git archive --format=tar.gz -o deploy.tar.gz HEAD
      
      - name: üöö Upload to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
      
      - name: üîß Deploy on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          AR_POSTGRES_PASSWORD: ${{ secrets.AR_POSTGRES_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            cd ${{ secrets.SERVER_PATH }}
            
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º
            tar xzf deploy.tar.gz
            rm deploy.tar.gz
            
            # –°–æ–∑–¥–∞—ë–º .env –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -f .env ]; then
              cat > .env << 'EOF'
          POSTGRES_DB=photobooks_db
          POSTGRES_USER=photobooks
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DATABASE_URL=postgresql://photobooks:${{ secrets.POSTGRES_PASSWORD }}@db:5432/photobooks_db
          
          AR_POSTGRES_PASSWORD=${{ secrets.AR_POSTGRES_PASSWORD }}
          AR_DATABASE_URL=postgresql://photobooks:${{ secrets.AR_POSTGRES_PASSWORD }}@ar-db:5432/ar_db
          
          DOMAIN=photobooksgallery.am
          FRONTEND_URL=https://photobooksgallery.am
          API_URL=https://photobooksgallery.am
          ALLOWED_ORIGINS=https://photobooksgallery.am
          
          TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          EOF
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker compose down
            
            # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
            docker compose build --no-cache
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º
            docker compose up -d
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
            sleep 10
            docker compose ps
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
            docker image prune -af
            
            echo "‚úÖ Deployment completed successfully!"
          ENDSSH
      
      - name: üì± Notify Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            MESSAGE="‚úÖ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ï–ù!%0A%0A–ö–æ–º–º–∏—Ç: ${{ github.sha }}%0A–í–µ—Ç–∫–∞: ${{ github.ref_name }}%0A–°–∞–π—Ç: https://photobooksgallery.am"
          else
            MESSAGE="‚ùå –î–ï–ü–õ–û–ô –ü–†–û–í–ê–õ–ò–õ–°–Ø!%0A%0A–ö–æ–º–º–∏—Ç: ${{ github.sha }}%0A–í–µ—Ç–∫–∞: ${{ github.ref_name }}%0A–ü—Ä–æ–≤–µ—Ä—å—Ç–µ GitHub Actions"
          fi
          
          curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${MESSAGE}" > /dev/null
