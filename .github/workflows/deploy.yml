name: ðŸš€ Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to photobooksgallery.am
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: ðŸ“¦ Create deployment archive
        run: |
          echo "Creating archive with git archive..."
          git archive --format=tar.gz -o deploy.tar.gz HEAD
          echo "Archive created successfully!"
          ls -lh deploy.tar.gz
          echo "Archive size: $(du -h deploy.tar.gz | cut -f1)"
      
      - name: ðŸšš Upload to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
      
      - name: ðŸ”§ Deploy on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          AR_POSTGRES_PASSWORD: ${{ secrets.AR_POSTGRES_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð» Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
          cat > .env.deploy << EOF
          POSTGRES_DB=photobooks_db
          POSTGRES_USER=photobooks
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          DATABASE_URL=postgresql://photobooks:${POSTGRES_PASSWORD}@db:5432/photobooks_db
          AR_POSTGRES_PASSWORD=${AR_POSTGRES_PASSWORD}
          AR_DATABASE_URL=postgresql://photobooks:${AR_POSTGRES_PASSWORD}@ar-db:5432/ar_db
          DOMAIN=photobooksgallery.am
          FRONTEND_URL=https://photobooksgallery.am
          API_URL=https://photobooksgallery.am
          ALLOWED_ORIGINS=https://photobooksgallery.am
          TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
          scp -o StrictHostKeyChecking=no .env.deploy ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/.env
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} \
            "cd ${SERVER_PATH} && \
            tar xzf deploy.tar.gz && \
            rm deploy.tar.gz && \
            docker compose down && \
            docker compose build --no-cache && \
            docker compose up -d && \
            sleep 10 && \
            docker compose ps && \
            docker image prune -af && \
            echo 'âœ… Deployment completed successfully!'"
      
      - name: ðŸ“± Notify Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            MESSAGE="âœ… Ð”Ð•ÐŸÐ›ÐžÐ™ Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!%0A%0AÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}%0AÐ’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}%0AÐ¡Ð°Ð¹Ñ‚: https://photobooksgallery.am"
          else
            MESSAGE="âŒ Ð”Ð•ÐŸÐ›ÐžÐ™ ÐŸÐ ÐžÐ’ÐÐ›Ð˜Ð›Ð¡Ð¯!%0A%0AÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}%0AÐ’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}%0AÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ GitHub Actions"
          fi
          
          curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${MESSAGE}" > /dev/null
