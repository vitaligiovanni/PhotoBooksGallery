name: ðŸš€ Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to photobooksgallery.am
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: âš™ï¸ Configure SSH for long connections
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << EOF
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 120
            TCPKeepAlive yes
            StrictHostKeyChecking no
          EOF
      
      - name: ðŸ“¦ Create deployment archive
        run: |
          echo "Creating archive with git archive..."
          git archive --format=tar.gz -o deploy.tar.gz HEAD
          echo "Archive created successfully!"
          ls -lh deploy.tar.gz
          echo "Archive size: $(du -h deploy.tar.gz | cut -f1)"
      
      - name: ðŸ§¹ Cleanup server (free disk space)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐµÐ³Ð¾
          scp cleanup-server.sh ${SERVER_USER}@${SERVER_HOST}:/tmp/
          ssh ${SERVER_USER}@${SERVER_HOST} "chmod +x /tmp/cleanup-server.sh && bash /tmp/cleanup-server.sh; rm -f /tmp/cleanup-server.sh || true"
      
      - name: ðŸ“ Ensure server directory exists
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH} && chmod 755 ${SERVER_PATH}"
      
      - name: ðŸšš Upload to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
          scp deploy.tar.gz ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
      
      - name: ðŸ”§ Deploy on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          AR_POSTGRES_PASSWORD: ${{ secrets.AR_POSTGRES_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð» Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
          cat > .env.deploy << EOF
          POSTGRES_DB=photobooks_db
          POSTGRES_USER=photobooks
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          DATABASE_URL=postgresql://photobooks:${POSTGRES_PASSWORD}@db:5432/photobooks_db
          AR_POSTGRES_PASSWORD=${AR_POSTGRES_PASSWORD}
          AR_DATABASE_URL=postgresql://photobooks:${AR_POSTGRES_PASSWORD}@ar-db:5432/ar_db
          DOMAIN=photobooksgallery.am
          FRONTEND_URL=https://photobooksgallery.am
          API_URL=https://photobooksgallery.am
          ALLOWED_ORIGINS=https://photobooksgallery.am
          TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
          scp .env.deploy ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/.env
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ (SSH keepalive Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð² ~/.ssh/config)
          ssh ${SERVER_USER}@${SERVER_HOST} \
            "cd ${SERVER_PATH} && \
            echo '--- Archive extract ---' && \
            tar xzf deploy.tar.gz && rm deploy.tar.gz && \
            echo '--- Stop containers (PRESERVE VOLUMES!) ---' && \
            docker compose down --remove-orphans || true && \
            echo '--- Build images ---' && \
            docker compose build && \
            echo '--- Start stack ---' && \
            docker compose up -d && \
            echo '--- Wait for services ---' && \
            sleep 12 && \
            docker compose ps && \
            echo '--- Prune dangling images ---' && \
            docker image prune -af || true && \
            echo 'âœ… Deployment completed successfully!'"
      
      - name: ðŸ“± Notify Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            TEXT="âœ… Ð”Ð•ÐŸÐ›ÐžÐ™ Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!\n\nÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}\nÐ’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}\nÐ¡Ð°Ð¹Ñ‚: https://photobooksgallery.am"
          else
            TEXT="âŒ Ð”Ð•ÐŸÐ›ÐžÐ™ ÐŸÐ ÐžÐ’ÐÐ›Ð˜Ð›Ð¡Ð¯!\n\nÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}\nÐ’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}\nÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ GitHub Actions"
          fi
          
          echo "ðŸ“± ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð² Telegram (status=$STATUS)..."
          
          # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ JSON Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
          TEXT_JSON=$(printf '%s' "$TEXT" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${TEXT_JSON}\"}")
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾"
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Telegram API: $RESPONSE"
            exit 1
          fi
