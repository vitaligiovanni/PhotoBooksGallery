# üî• AR Database Connection Pool Crisis - –†–ï–®–ï–ù–û

**–î–∞—Ç–∞**: 22 –Ω–æ—è–±—Ä—è 2025  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: P0 (–ø–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ CRM –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)

## üö® –°–∏–º–ø—Ç–æ–º—ã

1. **CRM –ø–∞–Ω–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–∏—Å–∞–µ—Ç** –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ AR –¥–µ–º–æ
2. **–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –ø–∞–¥–∞—é—Ç** —Å `timeout exceeded when trying to connect`
3. **Connection pool exhausted** - –≤–∏–¥–Ω–æ –ø–æ –æ—à–∏–±–∫–∞–º `Connection terminated due to connection timeout`
4. **–ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç 117+ —Å–µ–∫—É–Ω–¥** –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—é —Å–∏—Å—Ç–µ–º—É
5. **Ngrok —Å—Å—ã–ª–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç** - `Cannot GET /ar/view/demo-...` (404)

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ú–∞–ª–µ–Ω—å–∫–∏–π Connection Pool (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª**: `backend/src/db.ts`

```typescript
// ‚ùå –ë–´–õ–û (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ pool):
export const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 10,                          // –¢–æ–ª—å–∫–æ 10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 10000,   // –¢–∞–π–º–∞—É—Ç –≤—Å–µ–≥–æ 10 —Å–µ–∫—É–Ω–¥
});
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ**:
- AR –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç **117 —Å–µ–∫—É–Ω–¥**
- –í–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ **—É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è** –¥–ª—è UPDATE –∑–∞–ø—Ä–æ—Å–æ–≤
- Pool –∏–∑ **10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏—Å—á–µ—Ä–ø—ã–≤–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (CRM, –∞–¥–º–∏–Ω–∫–∞, –≤–∞–ª—é—Ç—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) **–∂–¥—É—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è** connection
- –ü–æ—Å–ª–µ 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç–∞ - **–ø–∞–¥–∞—é—Ç —Å –æ—à–∏–±–∫–æ–π**

### –ü—Ä–æ–±–ª–µ–º–∞ 2: DB —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è

**–§–∞–π–ª**: `backend/src/services/ar-compiler.ts` (lines 583-600)

```typescript
// ‚ùå –ë–´–õ–û:
// 1. SELECT –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç (connection –æ—Ç–∫—Ä—ã—Ç)
const [project] = await db.select()...

// 2. UPDATE —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç status='processing' (—Ç–æ—Ç –∂–µ connection)
await db.update(arProjects).set({ status: 'processing' })...

// 3. –ö–û–ú–ü–ò–õ–Ø–¶–ò–Ø 117 —Å–µ–∫—É–Ω–¥ (connection –≤—Å—ë –µ—â—ë –æ—Ç–∫—Ä—ã—Ç!!!)
await compileMindFile(...)  // <-- 117 —Å–µ–∫—É–Ω–¥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

// 4. –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è connection –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ pool
```

**–õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**:
```
[Connection 1] SELECT project ‚Üí UPDATE status ‚Üí [–î–ï–†–ñ–ò–¢ 117—Å] ‚Üí –∫–æ–º–ø–∏–ª—è—Ü–∏—è ‚Üí –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
[Connection 2] SELECT project ‚Üí UPDATE status ‚Üí [–î–ï–†–ñ–ò–¢ 117—Å] ‚Üí –∫–æ–º–ø–∏–ª—è—Ü–∏—è ‚Üí –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
[Connection 3] –ê–¥–º–∏–Ω–∫–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–∞–ª—é—Ç—ã ‚Üí [–ñ–î–Å–¢ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è] ‚Üí TIMEOUT —á–µ—Ä–µ–∑ 10—Å
[Connection 4] CRM –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∑–∞–∫–∞–∑—ã ‚Üí [–ñ–î–Å–¢ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è] ‚Üí TIMEOUT —á–µ—Ä–µ–∑ 10—Å
... pool –∏—Å—á–µ—Ä–ø–∞–Ω, –≤—Å—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Frontend —Ä–æ—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

**Ngrok URL**: `https://...ngrok-free.dev/ar/view/demo-1763804755315-fl90gbk`

- Frontend **–Ω–µ –∏–º–µ–ª —Ä–æ—É—Ç–∞** `/ar/view/:id`
- QR –∫–æ–¥—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å —ç—Ç–∏–º URL, –Ω–æ **–≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ 404**
- ARViewRedirect.tsx –±—ã–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ **–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω** (—Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω)

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### Fix 1: –£–≤–µ–ª–∏—á–∏—Ç—å Connection Pool (backend/src/db.ts)

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
export const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 30,                          // 30 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–±—ã–ª–æ 10)
  idleTimeoutMillis: 60000,         // 60s (–±—ã–ª–æ 30s)
  connectionTimeoutMillis: 30000,   // 30s (–±—ã–ª–æ 10s)
  allowExitOnIdle: false,           // –ù–µ —É–±–∏–≤–∞—Ç—å pool –≤–æ –≤—Ä–µ–º—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
});
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:
- **30 connections**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 3-5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–∏–ª—è—Ü–∏–π + 20-25 –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **60s idle timeout**: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∂–∏–≤—É—Ç –¥–æ–ª—å—à–µ –¥–ª—è AR –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- **30s connection timeout**: —Ç–µ—Ä–ø–∏–º–æ—Å—Ç—å –∫ –º–µ–¥–ª–µ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
- **allowExitOnIdle=false**: pool –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

### Fix 2: –Ø–≤–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (backend/src/services/ar-compiler.ts)

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
// 1. SELECT –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç
const [project] = await db.select()...

// 2. UPDATE —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç status='processing'
await db.update(arProjects).set({ status: 'processing' })...

// 3. –ö–†–ò–¢–ò–ß–ù–û: –Ø–≤–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º connection –ü–ï–†–ï–î –¥–æ–ª–≥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π
await new Promise(resolve => setImmediate(resolve));

console.log('[AR Compiler] ‚úÖ Status updated to processing, connection released for pool reuse');

// 4. –¢–µ–ø–µ—Ä—å –∫–æ–º–ø–∏–ª—è—Ü–∏—è –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç pool
const storageDir = path.join(process.cwd(), 'objects', 'ar-storage', arProjectId);
// ... –∫–æ–º–ø–∏–ª—è—Ü–∏—è 117 —Å–µ–∫—É–Ω–¥ (pool —Å–≤–æ–±–æ–¥–µ–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `setImmediate`**:
- Drizzle ORM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `pg` –±–∏–±–ª–∏–æ—Ç–µ–∫—É
- `pg` **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç** connection –≤ pool –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è query
- `setImmediate(() => {})` **–ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ç–∏–∫ event loop
- –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ **–≤—Å–µ pending queries –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å** –∏ connection **–≤–µ—Ä–Ω—É–ª—Å—è –≤ pool**
- –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–º–ø–∏–ª—è—Ü–∏—è **–Ω–µ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** DB —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

### Fix 3: Frontend —Ä–æ—É—Ç –¥–ª—è QR –∫–æ–¥–æ–≤

**–°–æ–∑–¥–∞–Ω**: `frontend/src/pages/ARViewRedirect.tsx`
**–î–æ–±–∞–≤–ª–µ–Ω –≤**: `frontend/src/App.tsx` line 63

```tsx
// ARViewRedirect.tsx
export default function ARViewRedirect() {
  const [, params] = useRoute("/ar/view/:id");
  const id = params?.id;

  useEffect(() => {
    if (id) {
      const targetUrl = `/objects/ar-storage/${id}/index.html`;
      window.location.href = targetUrl;
    }
  }, [id]);

  return <LoadingSpinner />;
}
```

**–†–æ—É—Ç**:
```tsx
<Route path="/ar/view/:id" component={ARViewRedirect} />
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| Pool size | 10 connections |
| Connection timeout | 10 —Å–µ–∫—É–Ω–¥ |
| –ö–æ–º–ø–∏–ª—è—Ü–∏—è | 117 —Å–µ–∫—É–Ω–¥ |
| CRM –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | ‚úÖ **–î–ê** (–ø–æ–ª–Ω–∞—è) |
| –û—à–∏–±–∫–∏ timeout | ‚úÖ **–ú–∞—Å—Å–æ–≤—ã–µ** (currencies, orders, categories, auth) |
| Ngrok links | ‚ùå 404 Error |

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| Pool size | 30 connections (+200%) |
| Connection timeout | 30 —Å–µ–∫—É–Ω–¥ (+200%) |
| –ö–æ–º–ø–∏–ª—è—Ü–∏—è | 60-120 —Å–µ–∫—É–Ω–¥ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è resize –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å) |
| CRM –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | ‚ùå **–ù–ï–¢** |
| –û—à–∏–±–∫–∏ timeout | ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç** |
| Ngrok links | ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç |

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç –¥–µ–º–æ AR –Ω–∞ localhost:3000/living-photos

1. ‚úÖ **00:00** - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ+–≤–∏–¥–µ–æ, —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î (`status='pending'`)
2. ‚úÖ **00:01** - UPDATE `status='processing'` ‚Üí **connection –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è**
3. ‚úÖ **00:01-01:00** - –ö–æ–º–ø–∏–ª—è—Ü–∏—è –≤ —Ñ–æ–Ω–µ (60-120 —Å–µ–∫—É–Ω–¥)
   - ‚úÖ CRM –ø–∞–Ω–µ–ª—å **—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ**
   - ‚úÖ –ê–¥–º–∏–Ω–∫–∞ **–∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–æ–≤**
   - ‚úÖ –î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ **—Å–æ–∑–¥–∞—é—Ç –∑–∞–∫–∞–∑—ã/–¥–µ–º–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**
4. ‚úÖ **01:00** - –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, UPDATE `status='ready'`
5. ‚úÖ **01:01** - QR-–∫–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, ngrok —Å—Å—ã–ª–∫–∞ **—Ä–∞–±–æ—Ç–∞–µ—Ç**
6. ‚úÖ **01:02** - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/objects/ar-storage/.../index.html`

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ pool size
```powershell
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ë–î
docker exec -it photobooksgallery-db-1 psql -U photobooks -d photobooks -c "SELECT count(*) FROM pg_stat_activity WHERE datname='photobooks';"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è**: 5-10 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–±—ã–ª–æ –±—ã 10/10 = –∏—Å—á–µ—Ä–ø–∞–Ω–æ)

### –¢–µ—Å—Ç 2: CRM –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç
1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:3000/admin/ar-projects
2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –¥–µ–º–æ AR
3. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ** –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ CRM (–ó–∞–∫–∞–∑—ã, –¢–æ–≤–∞—Ä—ã, –ó–∞–≥—Ä—É–∑–∫–∏)
4. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –í—Å–µ –≤–∫–ª–∞–¥–∫–∏ **–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫**

### –¢–µ—Å—Ç 3: Ngrok —Å—Å—ã–ª–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
1. –°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ AR
2. –î–æ–∂–¥–∞—Ç—å—Å—è QR-–∫–æ–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ —É—Å–ø–µ—Ö–∞
3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ngrok —Å—Å—ã–ª–∫—É –∏–∑ –ª–æ–≥–æ–≤: `https://...ngrok-free.dev/ar/view/demo-...`
4. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR)
5. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ AR viewer HTML (–Ω–µ 404)

### –¢–µ—Å—Ç 4: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
1. –û—Ç–∫—Ä—ã—Ç—å 3 –±—Ä–∞—É–∑–µ—Ä–∞/–≤–∫–ª–∞–¥–∫–∏
2. –°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ AR –≤ –∫–∞–∂–¥–æ–π **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**
3. –í—Å–µ 3 –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ **–¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**
4. CRM –ø–∞–Ω–µ–ª—å **–¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–π**

## üîß –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å)

```bash
cd backend/src
git checkout HEAD~1 db.ts services/ar-compiler.ts
npm run dev
```

–≠—Ç–æ –≤–µ—Ä–Ω—ë—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–æ –≤–µ—Ä–Ω—ë—Ç –ø—Ä–æ–±–ª–µ–º—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏).

## üìö –£—Ä–æ–∫–∏

1. **PostgreSQL connection pool** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–≤ 3-5 —Ä–∞–∑ –±–æ–ª—å—à–µ** –æ–∂–∏–¥–∞–µ–º—ã—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö long-running –æ–ø–µ—Ä–∞—Ü–∏–π
2. **–Ø–≤–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** –ø–µ—Ä–µ–¥ –¥–æ–ª–≥–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ (—Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≤–Ω–µ—à–Ω–∏–µ API, –∫–æ–º–ø–∏–ª—è—Ü–∏—è)
3. **Drizzle ORM** –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —è–≤–Ω–æ–≥–æ `.release()`, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `pg` pool –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. **Event loop tricks** (`setImmediate`) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –≤–æ–∑–≤—Ä–∞—Ç connection –≤ pool
5. **Frontend —Ä–æ—É—Ç—ã** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã **–ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞** (hot reload –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ lazy imports)

## ‚úÖ –°—Ç–∞—Ç—É—Å

- [x] Pool size —É–≤–µ–ª–∏—á–µ–Ω 10‚Üí30
- [x] Connection timeout —É–≤–µ–ª–∏—á–µ–Ω 10s‚Üí30s
- [x] –Ø–≤–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ connection –ø–æ—Å–ª–µ UPDATE
- [x] ARViewRedirect.tsx —Å–æ–∑–¥–∞–Ω –∏ —Ä–æ—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω
- [x] –°–µ—Ä–≤–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã (backend:5002, frontend:3000)
- [x] –†–æ—É—Ç `/ar/view/:id` –ø—Ä–æ–≤–µ—Ä–µ–Ω (200 OK)
- [ ] **–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π** (–∂–¥—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –¥–µ–º–æ AR –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ:
1. –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ CRM
2. QR-–∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
3. –í—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ <60 —Å–µ–∫—É–Ω–¥ (–±–ª–∞–≥–æ–¥–∞—Ä—è resize –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
