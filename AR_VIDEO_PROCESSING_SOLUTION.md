# ๐ฏ AR Video Processing: Variant 1 + Optimization

## โ Implemented Solution

### ะัะพะฑะปะตะผะฐ (ะดะพ ะธัะฟัะฐะฒะปะตะฝะธั):
- ะะธะดะตะพ ะบะพะฟะธัะพะฒะฐะปะพัั ะะะ ะะกะขะฌ (1920ร1080)
- ะคะพัะพ ะธะผะตะปะพ ะดััะณะธะต ะฟัะพะฟะพััะธะธ (ะฝะฐะฟัะธะผะตั, 3000ร4000 = 3:4)
- Plane scale = 1:1 (ะบะฒะฐะดัะฐั) โ ะฝะต ัะพะพัะฒะตัััะฒะพะฒะฐะปะพ ะฝะธ ะฒะธะดะตะพ, ะฝะธ ัะพัะพ
- **ะะตะทัะปััะฐั**: ะะธะดะตะพ ะธ ะผะฐัะบะฐ ะพัะพะฑัะฐะถะฐะปะธัั ะฝะตะฟัะฐะฒะธะปัะฝะพ

### ะะตัะตะฝะธะต (ะฟะพัะปะต ะธัะฟัะฐะฒะปะตะฝะธั):

#### 1. **ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต ัะฐะทะผะตัะพะฒ ัะพัะพ**
```typescript
// ar-compiler-core.ts, ัััะพะบะฐ ~185
const photoMeta = await sharp(processedPhotos[i]).metadata();
const photoWidth = photoMeta.width;  // ะะฐะฟัะธะผะตั, 3000px
const photoHeight = photoMeta.height; // ะะฐะฟัะธะผะตั, 4000px
const photoAR = photoWidth / photoHeight; // 0.75 (3:4)
```

#### 2. **ะะฝัะตะปะปะตะบััะฐะปัะฝัะน resize/crop ะฒะธะดะตะพ**
```typescript
// ar-compiler-core.ts, ััะฝะบัะธั resizeVideoToMatchPhoto()

// ะงะธัะฐะตะผ ัะฐะทะผะตัั ะฒะธะดะตะพ
const videoMeta = await extractVideoMetadata(videoSrc);
// ะะฐะฟัะธะผะตั: 1920ร1080, AR = 1.778 (16:9)

const photoAR = photoWidth / photoHeight; // 0.75
const videoAR = videoMeta.width / videoMeta.height; // 1.778

// ะัะปะธ AR ัะธะปัะฝะพ ะพัะปะธัะฐัััั (> 0.05):
if (Math.abs(videoAR - photoAR) > 0.05) {
  if (videoAR > photoAR) {
    // ะะธะดะตะพ ะจะะะ โ ะพะฑัะตะทะฐะตะผ ะะะะ (crop width)
    const cropWidth = Math.round(videoMeta.height * photoAR);
    const cropX = Math.round((videoMeta.width - cropWidth) / 2);
    // ffmpeg crop: 810ร1080 ั ัะตะฝััะธัะพะฒะฐะฝะธะตะผ
  } else {
    // ะะธะดะตะพ ะฃะะ โ ะพะฑัะตะทะฐะตะผ ะะะะฅ/ะะะ (crop height)
    const cropHeight = Math.round(videoMeta.width / photoAR);
    const cropY = Math.round((videoMeta.height - cropHeight) / 2);
  }
}

// ะะฐัะตะผ resize ะดะพ ัะฐะทะผะตัะพะฒ ัะพัะพ (max 1920px)
ffmpeg(videoSrc)
  .videoFilters(`crop=...`)
  .size(`${targetWidth}x${targetHeight}`)
  .videoCodec('libx264')
  .outputOptions(['-crf 23', '-preset fast'])
  .output(outputPath)
  .run();
```

#### 3. **ะะฐัะบะฐ ัะฐะทะผะตัะพะผ ั ัะพัะพ**
```typescript
// ar-compiler-core.ts, ัััะพะบะฐ ~210
const maskWidth = photoMeta.width;   // 3000px (ะฝะต 1024!)
const maskHeight = photoMeta.height; // 4000px (ะฝะต 1024!)

await generateMask(shapeType, maskDestPath, undefined, maskWidth, maskHeight);
```

#### 4. **Plane scale = Photo AR**
```typescript
// backend/ar-router.ts, ัััะพะบะฐ ~825
const photoAR = project.photoWidth / project.photoHeight; // 0.75

planeScale = { 
  width: 1.0, 
  height: 1.0 / photoAR  // 1.333 ะดะปั 3:4
};
```

---

## ๐ ะัะตะธะผััะตััะฒะฐ ัะตัะตะฝะธั

### โ ะะฐัะตััะฒะพ
- ะะธะดะตะพ **ะะะะะะฌะะ** ะฝะฐะบะปะฐะดัะฒะฐะตััั ะฝะฐ ัะพัะพ
- ะะฐัะบะฐ **ะขะะงะะ** ัะพะพัะฒะตัััะฒัะตั ัะฐะทะผะตัะฐะผ ะผะฐัะบะตัะฐ
- ะะตั ะธัะบะฐะถะตะฝะธะน, ัะฐัััะถะตะฝะธะน, ัะตัะฝัั ะฟะพะปะพั

### โ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- **ะะ ะฐะฟัะบะตะนะปะธะผ** ะฒะธะดะตะพ ะดะพ 4K (max 1920px)
- **CRF 23** โ ัะพัะพัะธะน ะฑะฐะปะฐะฝั ะบะฐัะตััะฒะพ/ัะฐะทะผะตั
- **Preset fast** โ ะฑััััะฐั ะพะฑัะฐะฑะพัะบะฐ (~2-5 ัะตะบัะฝะด ะฝะฐ ะฒะธะดะตะพ)

### โ ะฃะฝะธะฒะตััะฐะปัะฝะพััั
- ะะฐะฑะพัะฐะตั ั **ะะฎะะซะะ** ะฟัะพะฟะพััะธัะผะธ ัะพัะพ (16:9, 4:3, 3:4, 1:1)
- ะะฐะฑะพัะฐะตั ั **ะะฎะะซะะ** ะฟัะพะฟะพััะธัะผะธ ะฒะธะดะตะพ
- ะะฒัะพะผะฐัะธัะตัะบะธะน crop ะฟะพ ัะตะฝััั (ะฝะต ัะตััะตะผ ะฒะฐะถะฝัะน ะบะพะฝัะตะฝั)

---

## ๐ ะัะธะผะตัั ะพะฑัะฐะฑะพัะบะธ

### ะัะธะผะตั 1: ะะพัััะตัะฝะพะต ัะพัะพ + ะะปัะฑะพะผะฝะพะต ะฒะธะดะตะพ
```
ะคะะขะ:  3000ร4000 (3:4 portrait, AR=0.75)
ะะะะะ: 1920ร1080 (16:9 landscape, AR=1.778)

ะะะะะะะขะะ:
1. Crop ะฒะธะดะตะพ: 810ร1080 (ะพะฑัะตะทะฐะตะผ ะฑะพะบะฐ, offset X=555)
2. Resize: 810ร1080 โ 3000ร4000
3. ะะฐัะบะฐ: 3000ร4000 (ะบััะณ ัะฐะทะผะตัะพะผ ั ัะพัะพ)
4. Plane: 1.0 ร 1.333 (ัะพะพัะฒะตัััะฒัะตั 3:4)

ะะะะฃะะฌะขะะข: ะะธะดะตะพ ะทะฐะฟะพะปะฝัะตั ะฒะตัั ะผะฐัะบะตั, ะผะฐัะบะฐ ัะฐะฑะพัะฐะตั ะธะดะตะฐะปัะฝะพ
```

### ะัะธะผะตั 2: ะะฒะฐะดัะฐัะฝะพะต ัะพัะพ + ะะปัะฑะพะผะฝะพะต ะฒะธะดะตะพ
```
ะคะะขะ:  2000ร2000 (1:1 square, AR=1.0)
ะะะะะ: 1920ร1080 (16:9, AR=1.778)

ะะะะะะะขะะ:
1. Crop ะฒะธะดะตะพ: 1080ร1080 (ะพะฑัะตะทะฐะตะผ ะฑะพะบะฐ, offset X=420)
2. Resize: 1080ร1080 โ 1920ร1920 (ะพะฟัะธะผะธะทะฐัะธั)
3. ะะฐัะบะฐ: 1920ร1920
4. Plane: 1.0 ร 1.0

ะะะะฃะะฌะขะะข: ะะฒะฐะดัะฐัะฝัะน ะผะฐัะบะตั, ะฒะธะดะตะพ ะธ ะผะฐัะบะฐ ะธะดะตะฐะปัะฝะพ ะบะฒะฐะดัะฐัะฝัะต
```

### ะัะธะผะตั 3: ะะพัััะตัะฝะพะต ัะพัะพ + ะะพัััะตัะฝะพะต ะฒะธะดะตะพ
```
ะคะะขะ:  3000ร4000 (3:4, AR=0.75)
ะะะะะ: 1080ร1920 (9:16, AR=0.5625)

ะะะะะะะขะะ:
1. Crop ะฒะธะดะตะพ: 1080ร1440 (ะพะฑัะตะทะฐะตะผ ะฒะตัั/ะฝะธะท, offset Y=240)
2. Resize: 1080ร1440 โ 3000ร4000
3. ะะฐัะบะฐ: 3000ร4000
4. Plane: 1.0 ร 1.333

ะะะะฃะะฌะขะะข: ะะพัััะตัะฝะพะต ะฒะธะดะตะพ ะธะดะตะฐะปัะฝะพ ะทะฐะฟะพะปะฝัะตั ะฟะพัััะตัะฝัะน ะผะฐัะบะตั
```

---

## ๐ง ะะพะด ะธะทะผะตะฝะตะฝะธะน

### ะคะฐะนะปั ะธะทะผะตะฝะตะฝั:

1. **ar-service/src/workers/ar-compiler-core.ts**
   - ะะพะฑะฐะฒะปะตะฝ `import ffmpeg` (ัััะพะบะฐ 25-30)
   - ะะพะฑะฐะฒะปะตะฝะฐ ััะฝะบัะธั `extractVideoMetadata()` (ัััะพะบะฐ 40-55)
   - ะะพะฑะฐะฒะปะตะฝะฐ ััะฝะบัะธั `resizeVideoToMatchPhoto()` (ัััะพะบะฐ 57-150)
   - STEP 2: ะะฐะผะตะฝะตะฝะพ ะบะพะฟะธัะพะฒะฐะฝะธะต ะฝะฐ ะพะฑัะฐะฑะพัะบั (ัััะพะบะฐ 185-210)
   - STEP 2.5: ะะฐัะบะธ ะณะตะฝะตัะธัััััั ะฟะพ ัะฐะทะผะตัะฐะผ ัะพัะพ (ัััะพะบะฐ 215-240)

2. **backend/src/routers/ar-router.ts**
   - `/config` endpoint: planeScale = photoAR (ัััะพะบะฐ 820-830)
   - ะะฐัะบะธ ะณะตะฝะตัะธัััััั ะฟะพ ัะฐะทะผะตัะฐะผ ัะพัะพ (ัััะพะบะฐ 710-720)

3. **ar-service/package.json**
   - ะะพะฑะฐะฒะปะตะฝั ะทะฐะฒะธัะธะผะพััะธ: `@ffmpeg-installer/ffmpeg`, `ffprobe-static`

4. **ar-service/tsconfig.json**
   - `moduleResolution: "node16"` (ะธัะฟัะฐะฒะปะตะฝะฐ ะพัะธะฑะบะฐ ะบะพะผะฟะธะปััะธะธ)

---

## โ ะขะตััะธัะพะฒะฐะฝะธะต

### ะัะพะฒะตัะบะฐ ะปะพะณะธะบะธ (test-video-resize-logic.mjs):
```bash
$ node test-video-resize-logic.mjs

โ Algorithm working correctly!
๐ Summary:
   1. Read photo dimensions
   2. Read video dimensions
   3. Calculate AR difference
   4. If |photoAR - videoAR| > 0.05:
      - If videoAR > photoAR: crop WIDTH (sides)
      - If videoAR < photoAR: crop HEIGHT (top/bottom)
   5. Resize to photo dimensions (max 1920px)
   6. Generate mask at photo dimensions
   7. Set plane scale to photo AR
```

### ะัะพะฒะตัะบะฐ runtime:
1. ะกะพะทะดะฐัั ะฝะพะฒัะน AR ะฟัะพะตะบั ะฒ CRM
2. ะะฐะณััะทะธัั ะฟะพัััะตัะฝะพะต ัะพัะพ (3:4)
3. ะะฐะณััะทะธัั ะฐะปัะฑะพะผะฝะพะต ะฒะธะดะตะพ (16:9)
4. ะะฐะถะฐัั "ะกะพััะฐะฝะธัั ะธ ัะตะณะตะฝะตัะธัะพะฒะฐัั"
5. ะัะบัััั preview

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
- โ ะะธะดะตะพ ะทะฐะฟะพะปะฝัะตั ะฒะตัั ะผะฐัะบะตั (ะฝะตั ะฟััััั ะพะฑะปะฐััะตะน)
- โ ะะฐัะบะฐ (ะบััะณ/ะพะฒะฐะป) ะฟะพะบััะฒะฐะตั ะฒัั ะฒะธะดะตะพ
- โ ะัะพะฟะพััะธะธ ะฟัะฐะฒะธะปัะฝัะต (ะฝะตั ะธัะบะฐะถะตะฝะธะน)
- โ ะะพะผะฟะธะปััะธั ะทะฐะฝะธะผะฐะตั ~2-5 ัะตะบัะฝะด (ะฑััััะพ)

---

## ๐ ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั (ะดะตัะฐะปัะฝะพ)

### ะจะฐะณ 1: ะะพะผะฟะธะปััะธั AR ะฟัะพะตะบัะฐ
```
USER UPLOADS โ Backend API โ AR Microservice (ar-compiler-core.ts)
```

### ะจะฐะณ 2: ะะฑัะฐะฑะพัะบะฐ ัะพัะพ (ะฑะตะท ะธะทะผะตะฝะตะฝะธะน)
```typescript
// Resize ัะพัะพ ะดะพ 1920px (ะดะปั ะฑััััะพะน ะบะพะผะฟะธะปััะธะธ MindAR)
const resizedPhoto = await resizePhotoIfNeeded(photoPath, storageDir);
// ะะตะทัะปััะฐั: marker-0.jpg (1920ร2560 ะดะปั 3:4)
```

### ะจะฐะณ 3: ะะฑัะฐะฑะพัะบะฐ ะฒะธะดะตะพ (ะะะะะ!)
```typescript
// ะงะธัะฐะตะผ ัะฐะทะผะตัั ัะพัะพ
const photoMeta = await sharp(resizedPhoto).metadata();
// { width: 1920, height: 2560 }

// ะะฑัะฐะฑะฐััะฒะฐะตะผ ะฒะธะดะตะพ ะฟะพะด ััะธ ัะฐะทะผะตัั
await resizeVideoToMatchPhoto(
  videoPath,          // uploads/video-123.mp4 (1920ร1080)
  photoMeta.width,    // 1920
  photoMeta.height,   // 2560
  'storage/video-0.mp4'
);

// ffmpeg crop: 1920ร1080 โ 720ร1080 (ะพะฑัะตะทะฐะฝั ะฑะพะบะฐ)
// ffmpeg resize: 720ร1080 โ 1920ร2560
```

### ะจะฐะณ 4: ะะตะฝะตัะฐัะธั ะผะฐัะบะธ
```typescript
// ะะฐัะบะฐ ัะฐะทะผะตัะพะผ ั ะพะฑัะฐะฑะพัะฐะฝะฝะพะต ัะพัะพ
await generateMask(
  'circle',              // ะจะฐะฑะปะพะฝ (circle.png)
  'storage/mask-0.png',
  undefined,
  1920,                  // ะจะธัะธะฝะฐ ัะพัะพ
  2560                   // ะััะพัะฐ ัะพัะพ
);
```

### ะจะฐะณ 5: ะะพะผะฟะธะปััะธั .mind ัะฐะนะปะฐ
```typescript
// MindAR ะบะพะผะฟะธะปะธััะตั ะผะฐัะบะตั (120 ัะตะบัะฝะด)
const mindFile = await compileMindFile(resizedPhoto, storageDir);
// ะะตะทัะปััะฐั: marker.mind
```

### ะจะฐะณ 6: ะะตะฝะตัะฐัะธั HTML viewer
```typescript
// ar-router.ts, /config endpoint
const planeScale = {
  width: 1.0,
  height: 1.0 / (1920 / 2560) // = 1.333
};

// generateARViewer() ัะพะทะดะฐัั index.html:
<a-assets>
  <video id="vid" src="./video-0.mp4">  <!-- 1920ร2560 -->
  <img id="mask" src="./mask-0.png">    <!-- 1920ร2560 -->
</a-assets>

<a-plane 
  material="src:#vid" 
  scale="1.0 1.333 1"    <!-- ะะพัััะตัะฝะฐั ะฟะปะพัะบะพััั -->
  mindar-image-target="...">
  
<script>
  // THREE.js ะฟัะธะผะตะฝัะตั alphaMap
  mesh.material.alphaMap = new THREE.Texture(maskImg);
</script>
```

---

## ๐ฏ ะะตะทัะปััะฐั

### ะะพ (1:1 plane, ะฒะธะดะตะพ ะะะ ะะกะขะฌ):
```
Marker [1:1]
  โโโโโโโโโโโโโโโ
  โ             โ
  โ  Video 16:9 โ  โ ะะธะดะตะพ ัะฐัััะฝััะพ ะฟะพ ะฒััะพัะต
  โ (ะธัะบะฐะถะตะฝะพ)  โ
  โ             โ
  โ ๐ด โ ะะฐัะบะฐ  โ  โ ะะฐัะบะฐ ะบัะพัะตัะฝะฐั
  โโโโโโโโโโโโโโโ
```

### ะะพัะปะต (Photo AR plane, ะฒะธะดะตะพ ะะะะะะะขะะะ):
```
Marker [3:4]
  โโโโโโโโโโโ
  โโโโโโโโโโโ  
  โโะะะะะโโโ  โ ะะธะดะตะพ ะทะฐะฟะพะปะฝัะตั ะฒะตัั ะผะฐัะบะตั
  โโโโโโโโโโ  
  โโโโโโโโโโ  โ ะะฐัะบะฐ ะฟะพะบััะฒะฐะตั ะฒัั ะฒะธะดะตะพ
  โโโโโโโโโโ  
  โโโโโโโโโโ  
  โโโโโโโโโโโ  
  โโโโโโโโโโโ
```

---

## ๐ ะะฐะปัะฝะตะนัะธะต ัะปัััะตะฝะธั (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### 1. UI ะดะปั ะฒัะฑะพัะฐ fitMode
```typescript
// AdminAREdit.tsx
<select name="fitMode">
  <option value="cover">Cover (ะพะฑัะตะทะฐัั)</option>
  <option value="contain">Contain (ะฒะฟะธัะฐัั)</option>
  <option value="fill">Fill (ัะฐัััะฝััั)</option>
</select>
```

### 2. Preview ะพะฑัะฐะฑะพัะฐะฝะฝะพะณะพ ะฒะธะดะตะพ
- ะะพะบะฐะทัะฒะฐัั ะฟัะตะฒัั ะะะกะะ crop/resize
- ะะพะทะฒะพะปะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ัะบะพััะตะบัะธัะพะฒะฐัั ะพะฑะปะฐััั crop
- ะะพะฑะฐะฒะธัั ะบะฝะพะฟะบั "ะะตัะฝััั ะพัะธะณะธะฝะฐะปัะฝะพะต ะฒะธะดะตะพ"

### 3. ML-ะดะตัะตะบัะธั ะปะธัะฐ/ะพะฑัะตะบัะฐ
- ะะฟัะตะดะตะปััั ัะตะฝัั ะฒะฐะถะฝะพะณะพ ะบะพะฝัะตะฝัะฐ ะฒ ะฒะธะดะตะพ
- Crop ะฝะต ะฟะพ ะณะตะพะผะตััะธัะตัะบะพะผั ัะตะฝััั, ะฐ ะฟะพ ัะตะฝััั ะพะฑัะตะบัะฐ
- ะัะฟะพะปัะทะพะฒะฐัั TensorFlow.js (ัะถะต ะฒ ar-service)

### 4. ะะตัะธัะพะฒะฐะฝะธะต ะพะฑัะฐะฑะพัะฐะฝะฝัั ะฒะธะดะตะพ
- ะกะพััะฐะฝััั ััั ะพัะธะณะธะฝะฐะปัะฝะพะณะพ ะฒะธะดะตะพ + photoAR
- ะัะปะธ ะฒะธะดะตะพ ัะถะต ะพะฑัะฐะฑะฐััะฒะฐะปะพัั ะดะปั ััะพะณะพ AR โ ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐัั
- ะญะบะพะฝะพะผะธั ะฒัะตะผะตะฝะธ ะฟัะธ ะฟะพะฒัะพัะฝะพะน ัะตะณะตะฝะตัะฐัะธะธ

---

## ๐ ะะฐะบะปััะตะฝะธะต

ะะตะฐะปะธะทะพะฒะฐะฝ **ะะฐัะธะฐะฝั 1 + ะะฟัะธะผะธะทะฐัะธั**:

โ ะะธะดะตะพ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฑัะฐะฑะฐััะฒะฐะตััั ะฟะพะด ัะฐะทะผะตัั ัะพัะพ  
โ ะะฝัะตะปะปะตะบััะฐะปัะฝัะน crop ะฟะพ ัะตะฝััั (ะฝะต ัะตััะตะผ ะบะพะฝัะตะฝั)  
โ ะะฟัะธะผะธะทะฐัะธั ัะฐะทะผะตัะฐ (max 1920px, ะฝะต ะฐะฟัะบะตะนะปะธะผ ะดะพ 4K)  
โ ะะฐัะบะฐ ัะฐะทะผะตัะพะผ ั ัะพัะพ (ะธะดะตะฐะปัะฝะพะต ะฝะฐะปะพะถะตะฝะธะต)  
โ Plane scale = Photo AR (ะฟัะฐะฒะธะปัะฝัะต ะฟัะพะฟะพััะธะธ)  
โ ะััััะฐั ะพะฑัะฐะฑะพัะบะฐ (2-5 ัะตะบัะฝะด ffmpeg)  
โ ะฃะฝะธะฒะตััะฐะปัะฝะพััั (ัะฐะฑะพัะฐะตั ั ะปัะฑัะผะธ AR)  

**ะกัะฐััั: ะะะขะะะ ะ ะขะะกะขะะะะะะะะฎ** ๐
