# Контекст проекта — Принятые решения и настройки

Этот документ — компактная «истина в последней инстанции» по ключевым решениям, настройкам по умолчанию и ограничениям. Обновляйте файл при изменении этих параметров.

## Фотокнига: предпросмотр и раскладка

- Развороты/страницы
  - Для быстрого предпросмотра всегда рендерим ровно 10 разворотов (20 страниц).
  - Размер страницы по умолчанию: квадрат, 210×210 мм.
  - Разрешено повторное использование фотографий, чтобы заполнить все 10 разворотов.
- Безопасная область компоновки
  - Контент‑бокс составляет 90% от размеров страницы; все раскладки вписываются внутрь него.
  - Поля (gutter) между зонами: 3 мм; вся математика квантована (без «субпиксельного дрейфа»).
  - Коррекция последней строки/колонки, чтобы не возникали слишком тонкие «срезы».
- Ограничения зон
  - Применяется минимальный порог размера зоны (в мм); чрезмерно узкие зоны отвергаются.
  - Ограничены допустимые соотношения сторон, чтобы избежать экстремальных кропов.
- Кадрирование
  - Адаптивный центр‑кроп с подстройкой по лицам.
  - Отступ по лицам: ~5% дополнительного поля; сохраняем ключевые черты (без «обрезанных глаз»).
  - Защитный отступ ≥ 3 мм от краёв страницы.
- Шаблоны
  - Нормализуются/валидируются перед использованием; нефизичные шаблоны отфильтровываются.

## Лендинг: «WOW»-поток

- Drag‑and‑drop фотографий → мгновенный предпросмотр на 10 разворотов по правилам выше.
- Страницы рендерятся как идеальные квадраты (без серых полей) за счёт точного покрытия кропом.

## Баннеры (сервер + клиент)

- Видимость и размещение
  - Глобально монтируются в `AppLayout`, скрываются на админ‑страницах.
  - Клиент всегда передаёт текущий `pathname` при запросе активных баннеров.
- Таргетинг и расписание
  - Таргетинг по `pathname`; ЛЮБОЕ совпадение делает баннер кандидатом к показу.
  - Логика активного окна: если `start_date` = null → открытое начало; если `end_date` = null → открытый конец; при наличии дат «сейчас» должен попадать в оба интервала.
  - Переключатель `isActive` существует и переопределяет окна (ручное вкл/выкл).
- Кэширование и события
  - На сервере — in‑memory кэш для `getActiveBanners` (TTL ≈ 30 сек).
  - Инвалидация кэша при create/update/delete и при учёте показов/кликов.
- Админка и тестирование
  - В админ‑UI есть переключатель `isActive` и статистика.
  - Сид‑эндпойнт для быстрого E2E‑чека: `POST /api/banners/seed/test-home` (создаёт активный баннер для главной).

## Производительность и скорость UX

- Сплит по маршрутам: все страницы грузятся через `React.lazy + Suspense`.
- Отложенная загрузка некритичного UI: `BannerManager` и `AppPopups` подгружаются по требованию.
- Удалён глобальный импорт стилей Uppy из `client/src/index.css`.
- Исключён «тяжёлый» легаси‑файл из типизации TS: `client/src/lib/photobookUtils_old.ts`.
- Небольшой серверный кэш (см. Баннеры) для сглаживания нагрузки и задержек.

## Сборка и инструменты

- Vite 6 + Rollup. Интегрирован визуализатор бандла (treemap) для анализа после сборки.
- Tailwind/PostCSS — стандартная настройка; директивы Tailwind в CSS — ожидаемы.
- TypeScript исключает легаси‑файл фотокниги для ускорения разработки.

## Значения по умолчанию (ключевые константы)

- CONTENT_BOX_SCALE: 0.90
- TARGET_GUTTER_MM: 3
- FACE_PADDING_PERCENT: ~5
- Минимальные размеры зон и границы соотношений сторон соблюдаются (см. `client/src/lib/photobookUtils.ts`).

## Известные компромиссы

- Чтобы гарантировать 10 разворотов, допускается повтор фотографий при их недостатке.
- Слишком узкие или «странные» по аспекту зоны запрещены ради безопасности макета и качества кропа.

## Ближайшие шаги (лёгкие)

- Добиться стабильного формирования отчёта визуализатора и закоммитить артефакт.
- Подумать о `manualChunks` (vendor‑чанки) и о чистке зависимостей после `depcheck`.
- По возможности — отложенная загрузка более тяжёлых виджетов лендинга (карусели/анимации и т. п.).
- Виртуализация потенциально больших списков в админке/логах при необходимости.
