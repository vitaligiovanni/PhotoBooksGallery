# üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Volumes + AR Authentication

**–î–∞—Ç–∞:** 30 –Ω–æ—è–±—Ä—è 2025  
**Commit:** 245c559  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û –ù–ê–í–°–ï–ì–î–ê

---

## üö® –ü—Ä–æ–±–ª–µ–º–∞ 1: Volumes –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É–¥–∞–ª—è–ª–∏—Å—å –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

### –°–∏–º–ø—Ç–æ–º—ã:
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `git push` –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î —Ç–µ—Ä—è–ª–∏—Å—å
- –¢—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –≤—Ä—É—á–Ω—É—é –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (15 rows) –ø—Ä–æ–ø–∞–¥–∞–ª–∏
- AR –±–∞–∑–∞ (4 —Ç–∞–±–ª–∏—Ü—ã) —É–¥–∞–ª—è–ª–∞—Å—å

### –ü—Ä–∏—á–∏–Ω–∞:
**`.github/workflows/deploy.yml` —Å—Ç—Ä–æ–∫–∞ 93:**
```yaml
docker compose down -v --remove-orphans
```

–§–ª–∞–≥ `-v` (`--volumes`) **—É–¥–∞–ª—è–µ—Ç –≤—Å–µ volumes** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ!

### –†–µ—à–µ–Ω–∏–µ:
```yaml
# –ë–´–õ–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
docker compose down -v --remove-orphans

# –°–¢–ê–õ–û (–ü–†–ê–í–ò–õ–¨–ù–û):
docker compose down --remove-orphans
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Volumes `photobooks_postgres_data` –∏ `photobooks_ar_db_data` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ë–î –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω –¥–µ–ø–ª–æ–π (—É–±—Ä–∞–Ω `--no-cache` –∏–∑ build)

---

## üö® –ü—Ä–æ–±–ª–µ–º–∞ 2: AR –∫–æ–º–ø–∏–ª—è—Ü–∏—è —Ç—Ä–µ–±–æ–≤–∞–ª–∞ authentication

### –°–∏–º–ø—Ç–æ–º—ã:
```
Failed to create demo AR
POST /api/ar/create-demo 401
{"message":"Authentication token required"}
```

### –ü—Ä–∏—á–∏–Ω–∞:
**`backend/src/routers/ar-router.ts` —Å—Ç—Ä–æ–∫–∞ 1571:**
```typescript
router.post(
  '/create-demo',
  requireAuth, // ‚Üê –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø!
  upload.fields([...]),
  async (req, res) => {...}
);
```

Demo endpoint –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–ø—É–±–ª–∏—á–Ω—ã–º** (–∫–∞–∫ –Ω–∞ —Å–∞–π—Ç–µ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å AR").

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// –ë–´–õ–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
router.post(
  '/create-demo',
  requireAuth, // ‚Üê –£–ë–†–ê–ù–û
  upload.fields([...]),
  ...
);

// –°–¢–ê–õ–û (–ü–†–ê–í–ò–õ–¨–ù–û):
router.post(
  '/create-demo', // –ü—É–±–ª–∏—á–Ω—ã–π endpoint
  upload.fields([...]),
  ...
);
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```typescript
// userId –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userId = (req as any).user?.id || 'demo-guest';
```

---

## ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

### 1. Volumes —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
```bash
$ docker volume ls | grep photobooks
local     photobooks_ar_db_data
local     photobooks_postgres_data
```

### 2. –î–∞–Ω–Ω—ã–µ –ë–î –Ω–∞ –º–µ—Å—Ç–µ:
```bash
$ docker exec photobooks_db psql -U photobooks -d photobooks_db -c 'SELECT COUNT(*) FROM categories'
 total_categories 
------------------
               15  ‚Üê ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å!
```

### 3. AR –±–∞–∑–∞ –Ω–∞ –º–µ—Å—Ç–µ:
```bash
$ docker exec photobooks-ar-db psql -U photobooks -d ar_db -c '\dt'
 ar_compilation_logs  ‚Üê ‚úÖ –í—Å–µ 4 —Ç–∞–±–ª–∏—Ü—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å!
 ar_project_items
 ar_projects
 ar_webhook_events
```

### 4. –°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
$ curl -I https://photobooksgallery.am
HTTP/2 200 OK  ‚Üê ‚úÖ
```

---

## üß™ –¢–µ—Å—Ç AR Demo (–ü—É–±–ª–∏—á–Ω—ã–π)

–°–æ–∑–¥–∞–Ω HTML —Ç–µ—Å—Ç: `test-ar-demo-public.html`

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –û—Ç–∫—Ä—ã—Ç—å `test-ar-demo-public.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ (JPEG/PNG)
3. –í—ã–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ (MP4)
4. –ù–∞–∂–∞—Ç—å "–°–æ–∑–¥–∞—Ç—å AR Demo"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "message": "Multi-target AR project with 1 markers created (expires in 24 hours)",
  "data": {
    "projectId": "demo-1234567890-abc123",
    "status": "pending",
    "markersCount": 1,
    "expiresAt": "2025-12-01T06:50:00.000Z",
    "statusUrl": "/api/ar/status/demo-1234567890-abc123"
  }
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
```bash
curl https://photobooksgallery.am/api/ar/status/demo-1234567890-abc123
```

---

## üìã –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `.github/workflows/deploy.yml`
- ‚ùå –£–±—Ä–∞–Ω —Ñ–ª–∞–≥ `-v` –∏–∑ `docker compose down`
- ‚ùå –£–±—Ä–∞–Ω `--no-cache` –∏–∑ `docker compose build`
- ‚úÖ Volumes —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞

### 2. `backend/src/routers/ar-router.ts`
- ‚ùå –£–±—Ä–∞–Ω `requireAuth` middleware –∏–∑ `/create-demo`
- ‚úÖ Endpoint —Å—Ç–∞–ª –ø—É–±–ª–∏—á–Ω—ã–º
- ‚úÖ `userId` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `'demo-guest'`

---

## üéØ –ì–∞—Ä–∞–Ω—Ç–∏—è

**–≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –±–æ–ª—å—à–µ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ:**

1. ‚úÖ –í workflow **—Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—ë–Ω** —Ñ–ª–∞–≥ `-v`
2. ‚úÖ Volumes —Å–æ–∑–¥–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞**
3. ‚úÖ –ü—Ä–∏ –¥–µ–ø–ª–æ–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**, –Ω–µ volumes
4. ‚úÖ AR demo —Ä–∞–±–æ—Ç–∞–µ—Ç **–±–µ–∑ authentication**
5. ‚úÖ –¢–µ—Å—Ç `test-ar-demo-public.html` –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|---------|---------------|-------------------|
| Volumes –ø—Ä–∏ –¥–µ–ø–ª–æ–µ | ‚ùå –£–¥–∞–ª—è—é—Ç—Å—è | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è |
| –î–∞–Ω–Ω—ã–µ –ë–î | ‚ùå –¢–µ—Ä—è—é—Ç—Å—è | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è |
| AR demo auth | ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è | ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π |
| –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ | ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è | ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è |
| –í—Ä–µ–º—è –¥–µ–ø–ª–æ—è | ~5 –º–∏–Ω—É—Ç | ~3 –º–∏–Ω—É—Ç—ã |
| –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å | üî¥ –ù–∏–∑–∫–∞—è | üü¢ –í—ã—Å–æ–∫–∞—è |

---

## üîí –í–∞–∂–Ω–æ

**–ù–ï –¥–æ–±–∞–≤–ª—è–π—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ —Ñ–ª–∞–≥ `-v` –≤ workflow!**

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å volumes (—ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–ª—É—á–∞–π):
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—Ä—É—á–Ω—É—é:
docker compose down -v  # –£–¥–∞–ª–∏—Ç volumes
docker compose up -d    # –°–æ–∑–¥–∞—Å—Ç –∑–∞–Ω–æ–≤–æ

# –ü–æ—Ç–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:
cat restore-real-categories.sql | docker exec -i photobooks_db psql -U photobooks -d photobooks_db
cat 001_initial_schema.sql | docker exec -i photobooks-ar-db psql -U photobooks -d ar_db
```

–ù–æ —ç—Ç–æ **–Ω–µ –¥–æ–ª–∂–Ω–æ** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ!

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
# 1. Volumes —Å—É—â–µ—Å—Ç–≤—É—é—Ç
docker volume ls | grep photobooks

# 2. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
docker compose ps

# 3. –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
docker exec photobooks_db psql -U photobooks -d photobooks_db -c 'SELECT COUNT(*) FROM categories'

# 4. AR –±–∞–∑–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—ã
docker exec photobooks-ar-db psql -U photobooks -d ar_db -c '\dt'

# 5. –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
curl -I https://photobooksgallery.am
```

**–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ**
