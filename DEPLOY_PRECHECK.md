# Преддеплойная проверка (Pre-Deployment Checklist)

Этот документ помогает заранее выявить потенциальные проблемы при переносе приложения и базы данных в Docker / продакшн.

## 1. Цели проверки
- Гарантировать корректную кодировку (UTF8) для армянского и других языков.
- Убедиться, что миграции синхронизированы (нет пропущенных или изменённых задним числом).
- Проверить базовые параметры БД: lc_collate, lc_ctype, timezone.
- Зафиксировать "сигнатуру" набора миграций для сравнения между окружениями.
- Минимизировать риск поломок после обновления контейнера.

## 2. Быстрый запуск проверки
```bash
npm run predeploy:verify
```
Вывод сохраните в лог (например скопируйте в файл predeploy.log).

## 3. Интерпретация ключевых секций
### DB PARAMETERS
Показывает:
- server_encoding — должно быть UTF8
- lc_collate / lc_ctype — желательно одинаковые между окружениями (например C или en_US.UTF-8). Критично для сортировки текста.
- TimeZone — лучше UTC (или осознанный выбор).

### TABLES
Список текущих таблиц. Если чего-то ожидаемого нет — проверьте миграции.

### MIGRATION FILES
Перечень SQL файлов. Нельзя удалять или переписывать уже применённые — только добавлять новые.

### DRIZZLE STATE
Если присутствует таблица drizzle.__drizzle_migrations — сверяем что все имена из файлов есть в этой таблице.
Если отсутствует — значит миграции применялись вручную (это ок, но лучше унифицировать процесс).

### Сигнатура миграций
Хеш по именам + размерам файлов. Используйте его как контрольную точку:
1. Запустите локально — сохраните значение.
2. Запустите в Docker контейнере (с тем же скриптом) — значения должны совпасть.
Если отличается — либо файлы изменены, либо версии кода расходятся.

## 4. Типовые риски и предотвращение
| Риск | Симптом | Предотвращение |
|------|---------|----------------|
| Неверная кодировка | ????? вместо текста | Убедиться server_encoding=UTF8 до импорта данных |
| Переписанная миграция | Ошибки при apply или расхождения схемы | Никогда не редактировать старые *.sql, добавлять новые |
| Отсутствующая миграция | Таблица/колонка отсутствует в прод | Прогон predeploy:verify перед выкладкой |
| Разный TimeZone | Сдвиги дат/времени | Явно выставить TimeZone=UTC в Postgres |
| Сломанные данные при импорте | Некорректные символы | Использовать pg_dump/pg_restore с --encoding=UTF8 |

## 5. Рекомендованный процесс деплоя
1. Локально: `npm run build` и `npm run predeploy:verify`.
2. Сохранить сигнатуру миграций.
3. Сделать резервную копию продакшн БД: 
   ```bash
   pg_dump --format=custom --encoding=UTF8 --file=backup_$(date +%Y%m%d).dump $DATABASE_URL
   ```
4. Сборка Docker образа:
   ```bash
   docker build -t photobooks:latest .
   ```
5. Временный контейнер для проверки: 
   ```bash
   docker run --rm -e DATABASE_URL=$DATABASE_URL photobooks:latest node dist/server/index.js --check-only
   ```
   (Опционально добавить отдельный entrypoint для health-check сценария.)
6. Внутри контейнера запустить тот же скрипт проверки (нужен tsx или скомпилировать заранее):
   - Либо добавить в image стадию: `npm run predeploy:verify`.
7. Сравнить сигнатуру миграций и параметры encoding/locale.
8. Применить новые миграции (если используете drizzle-kit push) только после проверки:
   ```bash
   npm run db:push
   ```
9. Прогнать smoke-тесты: `/api/health`, `/api/debug/encoding`.
10. Переключить трафик (если используется reverse proxy) на новый контейнер.

## 6. Что делать если обнаружено несоответствие
- server_encoding не UTF8: создать новую БД корректно, перелить данные.
- Пропущенные миграции: применить их вручную или через drizzle-kit.
- Изменён файл старой миграции: восстановить оригинал из git истории, создать новую миграцию с изменениями.
- Не совпал hash миграций: убедиться что код и образ собраны с той же ветки/коммитом.

## 7. Дополнительно можно автоматизировать
- GitHub Action: запуск `npm run predeploy:verify` на pull request.
- Сохранение хеша миграций в артефакт CI.
- Автоматическая остановка деплоя при обнаружении предупреждений (non-zero exit code по флагу).

## 8. Быстрый чеклист перед деплоем
- [ ] Резервная копия сделана
- [ ] server_encoding=UTF8
- [ ] TimeZone=UTC
- [ ] Все миграции применены
- [ ] Hash миграций совпал
- [ ] Smoke endpoints возвращают 200

---
Если нужно — можем расширить скрипт проверкой конкретных критичных колонок или значений.
