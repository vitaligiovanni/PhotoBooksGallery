# Руководство по миграциям (Drizzle)

## 1. Термины
- generate — генерирует новый SQL файл на основе diff между schema.ts и последней миграцией.
- migrate — применяет все ещё не применённые *.sql миграции (идя последовательно по имени).
- push — напрямую синхронизирует схему без использования сохранённых файлов (НЕ используем в продакшне).

## 2. Поток разработки
1. Внести изменения в `shared/schema.ts`.
2. Сгенерировать новый файл миграции:
   ```bash
   npm run db:generate
   ```
3. Просмотреть созданный `migrations/00XX_*.sql` — убедиться что изменения корректны.
4. Применить локально:
   ```bash
   npm run db:migrate
   ```
5. Запустить приложение, убедиться что всё работает.
6. Закоммитить: изменённый schema.ts + новый SQL файл.

## 3. Продакшн / Docker
В контейнере при старте `entrypoint.sh` выполняет:
```
npx drizzle-kit migrate
```
Если нужно экстренно откатиться — поднимается резервная копия БД (откат миграций встроенными средствами Drizzle не реализован).

## 4. Строгий режим преддеплой проверки
Переменная окружения:
```
STRICT_PREDEPLOY=1
```
Приведёт к неуспешному выходу скрипта `predeploy-verify.ts`, если есть предупреждения (код 3). Это может блокировать деплой в CI.

## 5. Fallback режим
Для диагностики можно запустить с обходом миграций:
```
SKIP_MIGRATIONS=1
```
Для DEV можно включить старый push:
```
USE_PUSH=1
```

## 6. Baseline существующей БД
Если база создана до внедрения миграций:
1. Сделайте резервную копию (pg_dump).
2. Убедитесь что schema соответствует продакшн.
3. Сгенерируйте миграцию — она будет либо пустой (иногда) либо создаст полный набор.
4. Примените `npm run db:migrate` — таблица `drizzle.__drizzle_migrations` заполнится.
5. После этого любые изменения — только через generate + migrate.

## 7. Проверка состояния в рантайме
Запустить:
```bash
psql "$DATABASE_URL" -c 'select name, executed_at from drizzle.__drizzle_migrations order by executed_at;'
```

## 8. Типичные ошибки
| Проблема | Причина | Решение |
|----------|---------|---------|
| Изменили старый файл миграции | Переписывание истории | Откатить правку, создать новый файл миграции |
| Отсутствует запись в drizzle.__drizzle_migrations | migrate не запускался | Выполнить npm run db:migrate |
| gen_random_uuid() не существует | Нет pgcrypto | Добавлена миграция 0006_enable_pgcrypto.sql |
| Конфликт enum | Попытка удалить / изменить значение напрямую | Добавлять новые enum значения только расширением через миграцию |

## 9. Политика
- Не использовать `push` в продакшн.
- Не редактировать уже закоммиченные sql-файлы.
- Каждое изменение схемы фиксируется отдельным файлом.

