<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhotoBooks Gallery AR - Multi View a9f2fc43-8f96-49ff-abb5-174ea4077eba</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 1000; transition: opacity 0.5s; }
    #loading-screen.hidden { opacity: 0; pointer-events: none; }
    .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #instructions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 15px 25px; border-radius: 25px; font-size: 14px; z-index: 100; backdrop-filter: blur(10px); text-align: center; max-width: 80%; }
    .marker-found { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(76, 175, 80, 0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; z-index: 100; }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="spinner"></div>
    <h2>–ó–∞–≥—Ä—É–∑–∫–∞ AR...</h2>
    <p>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</p>
  </div>
  <div id="instructions">üì∏ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –ª—é–±—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞</div>
  <div class="marker-found" id="marker-found">‚úì –§–æ—Ç–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ!</div>
  
  <a-scene
    mindar-image="imageTargetSrc: ./marker-0.mind; filterMinCF:0.0001; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 5"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-assets>
      
      <video
        id="ar-video-0"
        src="./video-0.mp4"
        preload="metadata"
        loop
        playsinline
        webkit-playsinline
        crossorigin="anonymous"
        muted
      ></video>
      
  
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    
    <a-entity mindar-image-target="targetIndex: 0">
      <a-video
        id="ar-plane-0"
        src="#ar-video-0"
        position="0 0 0"
        rotation="0 0 0"
        width="1"
        height="0.75"
        class="clickable"
        data-auto-play="true"
      ></a-video>
      
    </a-entity>
  </a-scene>

  <script>
    const sceneEl = document.querySelector('a-scene');
    const loadingScreen = document.getElementById('loading-screen');
    const markerFoundIndicator = document.getElementById('marker-found');
    const videos = [document.getElementById('ar-video-0')];
    
    videos.forEach(v => { if (v) { try { v.pause(); v.muted = true; } catch {} } });

    sceneEl.addEventListener('loaded', () => {
      setTimeout(() => { loadingScreen.classList.add('hidden'); }, 1000);
    });

    // Handle multi-target detection
    
    const target0 = document.querySelector('[mindar-image-target][mindar-image-target\\.targetIndex="0"]');
    if (target0) {
      target0.addEventListener('targetFound', () => {
        console.log('Marker 0 found');
        markerFoundIndicator.style.display = 'block';
        const vid = videos[0];
        if (vid) {
          const autoPlay = vid.closest('a-video')?.getAttribute('data-auto-play') !== 'false';
          if (autoPlay) {
            try { vid.muted = false; } catch {}
            vid.play().catch(e => console.warn('Play failed:', e));
          }
        }
      });
      target0.addEventListener('targetLost', () => {
        console.log('Marker 0 lost');
        markerFoundIndicator.style.display = 'none';
        const vid = videos[0];
        if (vid) {
          try { vid.pause(); vid.currentTime = 0; vid.muted = true; } catch {}
        }
      });
    }

    // Live calibration via postMessage
    window.addEventListener('message', (evt) => {
      const data = evt?.data;
      if (!data || data.type !== 'ar-calibration') return;
      const { targetIndex, position, rotation, scale } = data.payload || {};
      if (targetIndex === undefined) return;
      const plane = document.getElementById('ar-plane-' + targetIndex);
      const maskImg = document.getElementById('ar-mask-image-' + targetIndex);
      try {
        if (plane && scale) { plane.setAttribute('width', String(scale.width)); plane.setAttribute('height', String(scale.height)); }
        if (plane && position) { plane.setAttribute('position', String(position.x)+' '+String(position.y)+' '+String(position.z)); }
        if (plane && rotation) { plane.setAttribute('rotation', String(rotation.x)+' '+String(rotation.y)+' '+String(rotation.z)); }
        if (maskImg && scale) { maskImg.setAttribute('width', String(scale.width)); maskImg.setAttribute('height', String(scale.height)); }
        if (maskImg && position) { var z = (position.z||0)+0.002; maskImg.setAttribute('position', String(position.x)+' '+String(position.y)+' '+String(z)); }
        if (maskImg && rotation) { maskImg.setAttribute('rotation', String(rotation.x)+' '+String(rotation.y)+' '+String(rotation.z)); }
      } catch (e) { console.warn('Live calibration failed', e); }
    });

    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission().then(response => {
        if (response === 'granted') { console.log('Device orientation permission granted'); }
      }).catch(console.error);
    }
  </script>
</body>
</html>